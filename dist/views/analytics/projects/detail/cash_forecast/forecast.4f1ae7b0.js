!function(){"use strict";angular.module("kt.lode").controller("ktCashForecastLayoutCtrl",["$scope","$window","$stateParams",function(a,b,c){a.data={},a.shared={},a.shared.tabs={forecastResult:!0,reForecast:!1};var d=JSON.parse(b.localStorage.getItem(c.projectID+".cashForecast")||"{}");a.shared.params=d}]).controller("ktCashForecastCtrl",["$scope","$timeout","$location","$window","$stateParams","ktProjectsService",function(a,b,c,d,e,f){var g=a.shared.params,h=c.search().tab||"forecastResult",i={text:"努力加载中...",color:"#3d4351",textColor:"#3d4351"};a.result={subTab:"asset_cashflow_trends"},a.shared.tabs.forecastResult="forecastResult"===h,a.shared.tabs.reForecast="reForecast"===h,a.project={},a.reForecast={periods:0,activePeriod:""},a.$watch("result.subTab",function(b,c){b!==c&&a.cashForecastChart.updateChartView()});var j={tooltip:{axisPointer:{type:"line",valueType:"rmb"},yAxisFormat:"rmb"}};a.cashForecastChart={radioDataShowType:"chart",tableData:[],initDone:!1,getData:function(){var c=this;f.get($.extend({subContent:"cashflow",projectID:e.projectID},g),function(d){a.data=d,g.start_date||$.extend(g,d.params);var e=g.startIndex=_.indexOf(d.dates,g.start_date);g.periods=d.dates.length-e-1,c.initDone=!0,c.data=d,c.updateChartView(),a.shared.goTo=function(c){a[c].initDone||b(function(){a[c].getData()},10)},a.updatePeriod=function(b,c){a.reForecast.activePeriod=b,a.reForecast.periods=a.project.validPeriods.length-c,a.reForecastChart.getData()}})},updateChartView:function(){var b=this.data,c=this.tableData=b[a.result.subTab];c=_.filter(c,function(b){var c=!1;switch(a.result.subTab){case"addup_cashflow_trends":c="累计现金流"!==b.name;break;case"asset_cashflow_trends":c="总现金流"!==b.name;break;default:c=!0}return c});var d=_.indexOf(b.dates,g.start_date),e=0;switch(a.result.subTab){case"addup_cashflow_trends":var f=_.chain(c).filter({name:"余额"}).map(function(a){return _.max(a.data)}).max().value(),h=_.chain(c).filter({name:"累计本金"}).map(function(a){return _.max(a.data)}).max().value();e=Math.max(f,h);break;case"asset_cashflow_trends":case"loss_cashflow_trends":var i=_.chain(c).map("data").value(),k=[];_.each(i[0],function(a,b){k[b]=0,_.each(i,function(a){k[b]+=a[b]})}),e=_.max(k);break;default:e=Math.pow(10,10)}var l=5,m=_.ceil(e/(1e4*l));m=_.ceil(m,1-_.toString(m).length),e=m*l*1e4,this.chartOptions=$.extend(!0,{},j,{legend:{data:_.map(c,"name")},xAxis:{type:"category",data:b.dates,boundaryGap:!1},tooltip:{reverse:"addup_cashflow_trends"!==a.result.subTab},yAxis:{name:"万元",boundaryGap:!1,interval:1e4*m,max:e},series:_.map(c,function(b,c){return 0===c&&(b.markLine={label:{normal:{formatter:"预测起始点",textStyle:{align:"center"}}},lineStyle:{normal:{type:"dashed"}},data:[[{coord:[d,0],symbol:"none"},{coord:[d,e],symbol:"arrow",symbolSize:[5,10]}]]}),b.type="line","addup_cashflow_trends"!==a.result.subTab&&(b.stack="堆积",b.areaStyle={normal:{}}),b})})},chartOptions:{}},a.reForecastChart={radioDataShowType:"chart",initDone:!1,showLoading:function(){var a=echarts.getInstanceByDom($("#reForecastChart1")[0]),b=echarts.getInstanceByDom($("#reForecastChart2")[0]),c=echarts.getInstanceByDom($("#reForecastChart3")[0]),d=echarts.getInstanceByDom($("#reForecastChart4")[0]);a&&a.showLoading(i),b&&b.showLoading(i),c&&c.showLoading(i),d&&d.showLoading(i)},hideLoading:function(){var a=echarts.getInstanceByDom($("#reForecastChart1")[0]),b=echarts.getInstanceByDom($("#reForecastChart2")[0]),c=echarts.getInstanceByDom($("#reForecastChart3")[0]),d=echarts.getInstanceByDom($("#reForecastChart4")[0]);a&&a.hideLoading(),b&&b.hideLoading(),c&&c.hideLoading(),d&&d.hideLoading()},getData:function(){var b=this;b.showLoading(),f.get({subContent:"re_forecast",projectID:e.projectID,start_date:a.reForecast.activePeriod},function(a){b.hideLoading(),b.initDone=!0,b.data=a,b.updateChartView()})},updateChartView:function(){var a=this.data,b={xAxis:{type:"category",data:a.dates}};this.chart1=$.extend(!0,{},j,b,{legend:{data:_.map(a.addup_cashflow_trends,"name")},yAxis:{name:"万元"},series:_.map(a.addup_cashflow_trends,function(a){return a.type="line",a})}),this.chart2=$.extend(!0,{},j,b,{legend:{data:_.map(a.balns_trends,"name")},yAxis:{name:"万元"},series:_.map(a.balns_trends,function(a){return a.type="line",a})}),this.chart3=$.extend(!0,{},j,b,{legend:{data:_.map(a.prepayment_rate_trends,"name")},tooltip:{yAxisFormat:"percent"},yAxis:{name:"%"},series:_.map(a.prepayment_rate_trends,function(a){return a.type="line",a})}),this.chart4=$.extend(!0,{},j,b,{legend:{data:_.map(a.loss_rate_trends,"name")},tooltip:{yAxisFormat:"percent"},yAxis:{name:"%"},series:_.map(a.loss_rate_trends,function(a){return a.type="line",a})})},chart1:{},chart2:{},chart3:{},chart4:{}},f.get({projectID:e.projectID,subContent:"cashflows",subID:"history_factors"},function(b){var c=a.project=b.project,d=a.project.validPeriods=_.clone(c.history_params.dates);_.indexOf(c.periods,g.start_date)>=d.length?(a.reForecast.activePeriod=d.slice(-6,1),a.reForecast.periods=d.slice(-6).length):(a.reForecast.activePeriod=g.start_date,a.reForecast.periods=d.length-_.indexOf(d,g.start_date))}),a.cashForecastChart.getData()}])}();